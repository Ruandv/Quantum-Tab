name: ðŸš€ Release Please

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - name: ï¿½ Create Release PR or Release
        uses: google-github-actions/release-please-action@v4
        id: release
        with:
          release-type: node
          config-file: .release-please-config.json
          manifest-file: .release-please-manifest.json

  build-and-package:
    runs-on: ubuntu-latest
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    steps:
      - name: ðŸ”„ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“¥ Install Dependencies
        run: npm ci

      - name: ðŸ” Verify manifest.json Version
        run: |
          VERSION="${{ needs.release-please.outputs.version }}"
          echo "Verifying manifest.json version matches release version: ${VERSION}"
          
          # Install jq if not available
          sudo apt-get install -y jq
          
          # Check current manifest version
          MANIFEST_VERSION=$(jq -r '.version' manifest.json)
          echo "Current manifest.json version: ${MANIFEST_VERSION}"
          echo "Expected version: ${VERSION}"
          
          if [ "$MANIFEST_VERSION" != "$VERSION" ]; then
            echo "âŒ Manifest version mismatch: $MANIFEST_VERSION != $VERSION"
            echo "Updating manifest.json..."
            jq --arg version "$VERSION" '.version = $version' manifest.json > manifest.tmp.json
            mv manifest.tmp.json manifest.json
            
            # Configure git and commit the fix
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add manifest.json
            git commit -m "fix: update manifest.json version to $VERSION"
            git push
            
            echo "âœ… Updated and committed manifest.json version to $VERSION"
          else
            echo "âœ… Manifest version is correct: $MANIFEST_VERSION"
          fi
          
          echo "ðŸ“„ Final manifest content:"
          cat manifest.json

      - name: ï¿½ðŸ” Type Check
        run: npm run type-check

      - name: ðŸ§¹ Lint Code
        run: npm run lint

      - name: âœ¨ Format Check
        run: npm run format -- --check

      - name: ðŸ—ï¸ Build Extension
        run: npm run build

      - name: ðŸ” Verify Build Output
        run: |
          echo "ðŸ“‚ Build directory contents:"
          ls -la dist/ || echo "âš ï¸ dist/ directory not found"
          
          if [ -f "dist/manifest.json" ]; then
            echo "ðŸ“„ Manifest.json content:"
            cat dist/manifest.json
            echo ""
            echo "ðŸ”§ Verifying required files exist:"
            test -f dist/manifest.json && echo "âœ… manifest.json exists"
            test -f dist/newtab.js && echo "âœ… newtab.js exists" || echo "âš ï¸ newtab.js not found"
            test -f dist/popup.js && echo "âœ… popup.js exists" || echo "âš ï¸ popup.js not found"
            test -f dist/background.js && echo "âœ… background.js exists" || echo "âš ï¸ background.js not found"
          else
            echo "âŒ manifest.json not found in dist/"
            exit 1
          fi

      - name: ðŸ“¦ Package Extension
        id: package
        run: |
          # Get version from release
          VERSION="${{ needs.release-please.outputs.version }}"
          PACKAGE_NAME="Quantum_Tab-$(date +%y%m%d)_${VERSION}"
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "package_name=${PACKAGE_NAME}" >> $GITHUB_OUTPUT
          
          # Create zip file for Chrome Web Store
          cd dist
          zip -r "../${PACKAGE_NAME}.zip" .
          cd ..
          
          # Create source code archive
          git archive --format=zip --prefix=quantum-tab-${VERSION}/ HEAD > "quantum-tab-source-${VERSION}.zip"
          
          echo "ðŸ“¦ Created packages:"
          ls -la *.zip

      - name: ï¿½ Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          files: |
            ${{ steps.package.outputs.package_name }}.zip
            quantum-tab-source-${{ needs.release-please.outputs.version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š Build Summary
        run: |
          echo "## ðŸŽ‰ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ needs.release-please.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Package:** ${{ steps.package.outputs.package_name }}.zip" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${{ needs.release-please.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Files Created:" >> $GITHUB_STEP_SUMMARY
          echo "- Chrome Extension Package: \`${{ steps.package.outputs.package_name }}.zip\`" >> $GITHUB_STEP_SUMMARY
          echo "- Source Code Archive: \`quantum-tab-source-${{ needs.release-please.outputs.version }}.zip\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Release:" >> $GITHUB_STEP_SUMMARY
          echo "- [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ needs.release-please.outputs.tag_name }})" >> $GITHUB_STEP_SUMMARY